FROM nvidia/cuda:8.0-devel

MAINTAINER Akiyama Laboratory, Tokyo Institute of Technology <megadock@bi.cs.titech.ac.jp>

RUN apt-get update
RUN apt-get install -y --no-install-recommends \
                        wget \
                        make \
                        g++

# FFTW
ENV FFTW_TARGET fftw-3.3.5

RUN wget -P /tmp http://www.fftw.org/${FFTW_TARGET}.tar.gz  &&  \
    tar xzf /tmp/${FFTW_TARGET}.tar.gz -C /tmp  &&  \
    cd /tmp/${FFTW_TARGET}  &&  \
    ./configure --enable-float --enable-sse2 --prefix=/usr/local/${FFTW_TARGET}  &&  \
    make  &&  \
    make check  &&  \
    make install


# CUDA_SAMPLES
ENV CUDA_SAMPLES_TARGET cuda-samples-8-0

RUN apt-get install -y --no-install-recommends cuda-samples-8-0


# MEGADOCK
ENV MEGADOCK_WORK_DIR /opt/MEGADOCK

ADD . ${MEGADOCK_WORK_DIR}
COPY ./Dockerfiles/Makefile.gpu ${MEGADOCK_WORK_DIR}/Makefile

WORKDIR ${MEGADOCK_WORK_DIR}

RUN cd ${MEGADOCK_WORK_DIR} && make

RUN ln -s ${MEGADOCK_WORK_DIR}/megadock-gpu /usr/local/bin/megadock-gpu  \
    && ln -s ${MEGADOCK_WORK_DIR}/decoygen /usr/local/bin/decoygen  \
    && ln -s ${MEGADOCK_WORK_DIR}/block /usr/local/bin/block  \
    && ln -s ${MEGADOCK_WORK_DIR}/ppiscore /usr/local/bin/ppiscore

WORKDIR ${MEGADOCK_WORK_DIR}/data

# CONFIGURATION
ENV OMP_NUM_THREADS 4
RUN echo "export OMP_NUM_THREADS=${OMP_NUM_THREADS}" >> /etc/profile
